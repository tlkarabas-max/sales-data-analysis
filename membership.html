<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biweekly Sales Performance & Goal Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #1e3c72;
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        /* File Upload Section */
        .upload-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .upload-card {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f7fafc;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .upload-card:hover {
            border-color: #4299e1;
            background: #ebf8ff;
        }
        
        .upload-card.loaded {
            border-color: #48bb78;
            background: #f0fff4;
            border-style: solid;
        }
        
        .upload-card .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .upload-card .title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .upload-card .description {
            color: #718096;
            font-size: 0.9em;
        }
        
        .upload-card input[type="file"] {
            display: none;
        }
        
        .check-mark {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #48bb78;
            font-size: 1.5em;
            display: none;
        }
        
        .upload-card.loaded .check-mark {
            display: block;
        }
        
        /* Process Button */
        .process-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 20px;
            width: 100%;
        }
        
        .process-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .process-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Results Section */
        .results-section {
            display: none;
        }
        
        .results-section.active {
            display: block;
        }
        
        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-card .label {
            color: #718096;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2d3748;
            line-height: 1;
        }
        
        .summary-card .subtitle {
            color: #a0aec0;
            font-size: 0.9em;
            margin-top: 8px;
        }
        
        .summary-card.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .summary-card.highlight .label,
        .summary-card.highlight .value,
        .summary-card.highlight .subtitle {
            color: white;
        }
        
        /* Role Badges */
        .role-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .role-guide {
            background: #bfdbfe;
            color: #1e40af;
        }
        
        .role-manager {
            background: #fcd34d;
            color: #78350f;
        }
        
        .role-unknown {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        /* Biweekly Table */
        .table-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-title {
            font-size: 1.5em;
            color: #2d3748;
            font-weight: 600;
        }
        
        .export-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
        }
        
        .export-btn:hover {
            background: #38a169;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        thead {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            background: #f7fafc;
            z-index: 10;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }
        
        tbody tr:hover {
            background: #f7fafc;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Performance Indicators */
        .performance-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .performance-excellent {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .performance-good {
            background: #bee3f8;
            color: #2c5282;
        }
        
        .performance-average {
            background: #feebc8;
            color: #7c2d12;
        }
        
        .performance-low {
            background: #fed7d7;
            color: #742a2a;
        }
        
        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.3em;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        canvas {
            max-height: 400px;
        }
        
        /* Filters */
        .filters-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        
        .filters-section.active {
            display: block;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .filter-group label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        /* Messages */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .message.active {
            display: block;
        }
        
        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .message.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .message.warning {
            background: #feebc8;
            color: #7c2d12;
            border: 1px solid #f6ad55;
        }
        
        /* Info Box */
        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .info-box h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }
        
        .info-box p {
            color: #555;
            font-size: 0.95em;
            line-height: 1.5;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .upload-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.85em;
            }
            
            th, td {
                padding: 8px;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            .upload-section,
            .filters-section,
            .export-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>📊</span>
                Biweekly Sales Performance & Goal Analysis
            </h1>
            <div class="subtitle">
                Track actual memberships sold by Experience Guides and Managers,<br>
                calculate adjusted goals excluding OOT guests, and measure performance based on local guest opportunities.
            </div>
        </div>
        
        <!-- File Upload Section -->
        <div class="upload-section">
            <h2 style="color: #2d3748; margin-bottom: 20px;">Upload Required Files</h2>
            
            <div class="info-box">
                <h4>ℹ️ Note</h4>
                <p>This analysis focuses on Experience Guides and Managers who handle guest checkouts and membership sales. 
                Massage Therapists are excluded from this analysis as they don't typically process sales transactions.</p>
            </div>
            
            <div class="upload-grid">
                <!-- Memberships Upload -->
                <div class="upload-card" id="membershipCard">
                    <label for="membershipFile">
                        <span class="check-mark">✓</span>
                        <div class="icon">📋</div>
                        <div class="title">Membership Data</div>
                        <div class="description">Upload Memberships CSV file</div>
                        <input type="file" id="membershipFile" accept=".csv">
                    </label>
                </div>
                
                <!-- OOT Guests Upload -->
                <div class="upload-card" id="ootCard">
                    <label for="ootFile">
                        <span class="check-mark">✓</span>
                        <div class="icon">🌍</div>
                        <div class="title">Guest Data (OOT)</div>
                        <div class="description">Upload NS Guests OOT CSV file</div>
                        <input type="file" id="ootFile" accept=".csv">
                    </label>
                </div>
                
                <!-- Payroll Upload -->
                <div class="upload-card" id="payrollCard">
                    <label for="payrollFile">
                        <span class="check-mark">✓</span>
                        <div class="icon">💰</div>
                        <div class="title">Payroll Data</div>
                        <div class="description">Upload Payroll Journal CSV file</div>
                        <input type="file" id="payrollFile" accept=".csv">
                    </label>
                </div>
            </div>
            
            <button class="process-button" id="processBtn" disabled>
                Process Data & Generate Analysis
            </button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                Processing your data...
            </div>
            
            <div class="message error" id="errorMsg"></div>
            <div class="message success" id="successMsg"></div>
            <div class="message warning" id="warningMsg"></div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Summary Cards -->
            <div class="summary-grid" id="summaryCards"></div>
            
            <!-- Filters -->
            <div class="filters-section" id="filtersSection">
                <h3 style="color: #2d3748; margin-bottom: 20px;">Filter Results</h3>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="roleFilter">Role/Position</label>
                        <select id="roleFilter">
                            <option value="all">All Roles</option>
                            <option value="guide">Experience Guides</option>
                            <option value="manager">Managers</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="periodFilter">Pay Period</label>
                        <select id="periodFilter">
                            <option value="all">All Periods</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="staffFilter">Staff Member</label>
                        <select id="staffFilter">
                            <option value="all">All Staff</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="performanceFilter">Performance Level</label>
                        <select id="performanceFilter">
                            <option value="all">All Levels</option>
                            <option value="excellent">Excellent (>100%)</option>
                            <option value="good">Good (75-100%)</option>
                            <option value="average">Average (50-75%)</option>
                            <option value="low">Below Average (<50%)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Biweekly Performance Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">📈 Biweekly Sales Performance</div>
                    <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
                </div>
                <table id="performanceTable">
                    <thead>
                        <tr>
                            <th>Pay Period</th>
                            <th>Staff Member</th>
                            <th>Role</th>
                            <th>Hours Worked</th>
                            <th>Local Guests</th>
                            <th>OOT Guests</th>
                            <th>Actual Sales</th>
                            <th>Adjusted Goal</th>
                            <th>Achievement %</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="performanceTableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Charts Section -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Sales Trend Over Time</div>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Experience Guides vs Managers</div>
                    <canvas id="roleChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Top Performers</div>
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Achievement Rate by Role</div>
                    <canvas id="achievementChart"></canvas>
                </div>
            </div>
            
            <!-- Detailed Metrics Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">📊 Detailed Metrics by Staff</div>
                </div>
                <table id="metricsTable">
                    <thead>
                        <tr>
                            <th>Staff Member</th>
                            <th>Role</th>
                            <th>Total Hours</th>
                            <th>Total Sales</th>
                            <th>Sales/Hour</th>
                            <th>Conversion Rate</th>
                            <th>Avg Achievement</th>
                            <th>Best Period</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody id="metricsTableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Global data storage
        let membershipData = null;
        let ootData = null;
        let payrollData = null;
        let processedData = null;
        let charts = {};
        
        // Staff role mapping - Experience Guides and Managers only
        // Customize this based on your actual staff
        const staffRoles = {
            // Experience Guides
            'Angela McNally': 'guide',
            'Edward Franklin': 'guide',
            'Kameko Vinyard': 'guide',
            'Christina Vega': 'guide',
            'Crawford Gallagher': 'guide',
            'Alejandra Lode': 'guide',
            'Isabella Acuna': 'guide',
            // Managers
            'Api owner': 'manager',
            'Anna Mercadante': 'manager',
            // Add more staff as needed
        };
        
        // File upload handlers
        document.getElementById('membershipFile').addEventListener('change', (e) => handleFileUpload(e, 'membership'));
        document.getElementById('ootFile').addEventListener('change', (e) => handleFileUpload(e, 'oot'));
        document.getElementById('payrollFile').addEventListener('change', (e) => handleFileUpload(e, 'payroll'));
        document.getElementById('processBtn').addEventListener('click', processData);
        
        // Filter handlers
        document.getElementById('roleFilter').addEventListener('change', filterData);
        document.getElementById('periodFilter').addEventListener('change', filterData);
        document.getElementById('staffFilter').addEventListener('change', filterData);
        document.getElementById('performanceFilter').addEventListener('change', filterData);
        
        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const parsed = Papa.parse(content, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false
                });
                
                switch(type) {
                    case 'membership':
                        membershipData = parsed.data;
                        document.getElementById('membershipCard').classList.add('loaded');
                        break;
                    case 'oot':
                        ootData = parsed.data;
                        document.getElementById('ootCard').classList.add('loaded');
                        break;
                    case 'payroll':
                        payrollData = parsed.data;
                        document.getElementById('payrollCard').classList.add('loaded');
                        break;
                }
                
                // Enable process button if all files are loaded
                if (membershipData && ootData && payrollData) {
                    document.getElementById('processBtn').disabled = false;
                }
            };
            
            reader.readAsText(file);
        }
        
        function getStaffRole(staffName) {
            return staffRoles[staffName] || 'unknown';
        }
        
        function getRoleBadge(role) {
            const badges = {
                'guide': '<span class="role-badge role-guide">Experience Guide</span>',
                'manager': '<span class="role-badge role-manager">Manager</span>',
                'unknown': '<span class="role-badge role-unknown">Unknown</span>'
            };
            return badges[role] || badges['unknown'];
        }
        
        function processData() {
            const loading = document.getElementById('loading');
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');
            const warningMsg = document.getElementById('warningMsg');
            
            // Reset messages
            errorMsg.classList.remove('active');
            successMsg.classList.remove('active');
            warningMsg.classList.remove('active');
            loading.classList.add('active');
            
            try {
                // Process biweekly periods
                const periods = extractBiweeklyPeriods();
                
                // Process staff data
                const staffMetrics = calculateStaffMetrics(periods);
                
                // Store processed data
                processedData = {
                    periods: periods,
                    staffMetrics: staffMetrics,
                    summary: calculateSummary(staffMetrics)
                };
                
                // Display results
                displayResults();
                
                // Show success message
                successMsg.textContent = `✅ Successfully processed ${membershipData.length} membership records, ${ootData.length} guest records, and ${payrollData.length} payroll records`;
                successMsg.classList.add('active');
                
                // Show results section
                document.getElementById('resultsSection').classList.add('active');
                document.getElementById('filtersSection').classList.add('active');
                
            } catch (error) {
                errorMsg.textContent = `❌ Error: ${error.message}`;
                errorMsg.classList.add('active');
                console.error('Processing error:', error);
            } finally {
                loading.classList.remove('active');
            }
        }
        
        function extractBiweeklyPeriods() {
            // Get unique pay periods from payroll data
            const periods = new Map();
            
            payrollData.forEach(row => {
                const periodStart = row['Period Start'];
                const periodEnd = row['Period End'];
                const key = `${periodStart}-${periodEnd}`;
                
                if (!periods.has(key)) {
                    periods.set(key, {
                        start: periodStart,
                        end: periodEnd,
                        staff: new Map()
                    });
                }
                
                const period = periods.get(key);
                const staffName = `${row['First Name']} ${row['Last Name']}`.trim();
                
                if (staffName && staffName !== ' ') {
                    const hours = parseFloat(row['Hourly Hrs'] || 0) + 
                                 parseFloat(row['Overtime Hrs'] || 0) +
                                 parseFloat(row['Salaried Hrs'] || 0);
                    
                    if (!period.staff.has(staffName)) {
                        period.staff.set(staffName, {
                            hours: 0,
                            sales: 0,
                            localGuests: 0,
                            ootGuests: 0,
                            role: getStaffRole(staffName)
                        });
                    }
                    
                    period.staff.get(staffName).hours += hours;
                }
            });
            
            return Array.from(periods.values()).sort((a, b) => 
                new Date(a.start) - new Date(b.start)
            );
        }
        
        function calculateStaffMetrics(periods) {
            // Process each period
            periods.forEach(period => {
                const startDate = new Date(period.start);
                const endDate = new Date(period.end);
                
                // Count memberships sold in this period
                membershipData.forEach(row => {
                    const saleDate = new Date(row['Sale Date']);
                    const soldBy = row['Sold By'];
                    
                    if (saleDate >= startDate && saleDate <= endDate) {
                        if (period.staff.has(soldBy)) {
                            period.staff.get(soldBy).sales++;
                        } else {
                            // Add staff member if they sold something but aren't in payroll
                            period.staff.set(soldBy, {
                                hours: 0,
                                sales: 1,
                                localGuests: 0,
                                ootGuests: 0,
                                role: getStaffRole(soldBy)
                            });
                        }
                    }
                });
                
                // Count OOT and Local guests in this period
                ootData.forEach(row => {
                    const saleDate = new Date(row['Sale Date']);
                    const closedBy = row['Closed By'];
                    const type = row['Type (Local/OOT)'];
                    
                    if (saleDate >= startDate && saleDate <= endDate) {
                        if (period.staff.has(closedBy)) {
                            if (type === 'Out of Town') {
                                period.staff.get(closedBy).ootGuests++;
                            } else if (type === 'Local') {
                                period.staff.get(closedBy).localGuests++;
                            }
                        } else if (type) {
                            // Add staff if they closed guests but aren't in other data
                            const newStaff = {
                                hours: 0,
                                sales: 0,
                                localGuests: type === 'Local' ? 1 : 0,
                                ootGuests: type === 'Out of Town' ? 1 : 0,
                                role: getStaffRole(closedBy)
                            };
                            period.staff.set(closedBy, newStaff);
                        }
                    }
                });
            });
            
            // Calculate goals and achievement
            periods.forEach(period => {
                period.staff.forEach((data, staffName) => {
                    // Different conversion targets for different roles
                    let conversionTarget = 0.10; // Default 10% for Experience Guides
                    if (data.role === 'manager') {
                        conversionTarget = 0.12; // Managers might have higher targets
                    }
                    
                    // Calculate adjusted goal (based on local guests only)
                    data.adjustedGoal = Math.round(data.localGuests * conversionTarget);
                    
                    // Calculate achievement percentage
                    data.achievementPercent = data.adjustedGoal > 0 
                        ? ((data.sales / data.adjustedGoal) * 100).toFixed(1)
                        : data.sales > 0 ? '100.0' : '0';
                    
                    // Calculate sales per hour
                    data.salesPerHour = data.hours > 0 
                        ? (data.sales / data.hours).toFixed(2)
                        : 0;
                    
                    // Determine performance level
                    const achievement = parseFloat(data.achievementPercent);
                    if (achievement >= 100) {
                        data.performanceLevel = 'excellent';
                    } else if (achievement >= 75) {
                        data.performanceLevel = 'good';
                    } else if (achievement >= 50) {
                        data.performanceLevel = 'average';
                    } else {
                        data.performanceLevel = 'low';
                    }
                });
            });
            
            return periods;
        }
        
        function calculateSummary(staffMetrics) {
            let totalSales = 0;
            let totalHours = 0;
            let totalLocalGuests = 0;
            let totalOOTGuests = 0;
            let totalGoals = 0;
            let guidesTotal = 0;
            let managersTotal = 0;
            
            staffMetrics.forEach(period => {
                period.staff.forEach(data => {
                    totalSales += data.sales;
                    totalHours += data.hours;
                    totalLocalGuests += data.localGuests;
                    totalOOTGuests += data.ootGuests;
                    totalGoals += data.adjustedGoal;
                    
                    if (data.role === 'guide') {
                        guidesTotal += data.sales;
                    } else if (data.role === 'manager') {
                        managersTotal += data.sales;
                    }
                });
            });
            
            return {
                totalSales: totalSales,
                totalHours: totalHours.toFixed(1),
                totalLocalGuests: totalLocalGuests,
                totalOOTGuests: totalOOTGuests,
                avgSalesPerHour: totalHours > 0 ? (totalSales / totalHours).toFixed(2) : 0,
                overallAchievement: totalGoals > 0 ? ((totalSales / totalGoals) * 100).toFixed(1) : 0,
                guidesTotal: guidesTotal,
                managersTotal: managersTotal
            };
        }
        
        function displayResults() {
            displaySummaryCards();
            populateFilters();
            displayTableData();
            displayCharts();
            displayDetailedMetrics();
        }
        
        function displaySummaryCards() {
            const summary = processedData.summary;
            const cardsHTML = `
                <div class="summary-card highlight">
                    <div class="label">Total Memberships Sold</div>
                    <div class="value">${summary.totalSales}</div>
                    <div class="subtitle">Across all periods</div>
                </div>
                <div class="summary-card">
                    <div class="label">Experience Guides Sales</div>
                    <div class="value">${summary.guidesTotal}</div>
                    <div class="subtitle">${((summary.guidesTotal/summary.totalSales)*100).toFixed(0)}% of total</div>
                </div>
                <div class="summary-card">
                    <div class="label">Managers Sales</div>
                    <div class="value">${summary.managersTotal}</div>
                    <div class="subtitle">${((summary.managersTotal/summary.totalSales)*100).toFixed(0)}% of total</div>
                </div>
                <div class="summary-card">
                    <div class="label">Local Guests Served</div>
                    <div class="value">${summary.totalLocalGuests.toLocaleString()}</div>
                    <div class="subtitle">Potential members</div>
                </div>
                <div class="summary-card">
                    <div class="label">Sales per Hour</div>
                    <div class="value">${summary.avgSalesPerHour}</div>
                    <div class="subtitle">Average productivity</div>
                </div>
                <div class="summary-card">
                    <div class="label">Overall Achievement</div>
                    <div class="value">${summary.overallAchievement}%</div>
                    <div class="subtitle">Of adjusted goals</div>
                </div>
            `;
            
            document.getElementById('summaryCards').innerHTML = cardsHTML;
        }
        
        function populateFilters() {
            // Populate period filter
            const periodFilter = document.getElementById('periodFilter');
            periodFilter.innerHTML = '<option value="all">All Periods</option>';
            
            processedData.periods.forEach((period, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${period.start} - ${period.end}`;
                periodFilter.appendChild(option);
            });
            
            // Populate staff filter
            const staffFilter = document.getElementById('staffFilter');
            const staffSet = new Set();
            
            processedData.periods.forEach(period => {
                period.staff.forEach((data, staffName) => {
                    staffSet.add(staffName);
                });
            });
            
            staffFilter.innerHTML = '<option value="all">All Staff</option>';
            Array.from(staffSet).sort().forEach(staffName => {
                const option = document.createElement('option');
                option.value = staffName;
                option.textContent = staffName;
                staffFilter.appendChild(option);
            });
        }
        
        function displayTableData() {
            const tbody = document.getElementById('performanceTableBody');
            let html = '';
            
            processedData.periods.forEach(period => {
                period.staff.forEach((data, staffName) => {
                    const performanceBadge = getPerformanceBadge(data.performanceLevel);
                    const roleBadge = getRoleBadge(data.role);
                    
                    html += `
                        <tr data-period="${period.start}-${period.end}" 
                            data-staff="${staffName}" 
                            data-role="${data.role}"
                            data-performance="${data.performanceLevel}">
                            <td>${period.start} - ${period.end}</td>
                            <td><strong>${staffName}</strong></td>
                            <td>${roleBadge}</td>
                            <td>${data.hours.toFixed(1)}</td>
                            <td>${data.localGuests.toLocaleString()}</td>
                            <td>${data.ootGuests.toLocaleString()}</td>
                            <td><strong>${data.sales}</strong></td>
                            <td>${data.adjustedGoal}</td>
                            <td><strong>${data.achievementPercent}%</strong></td>
                            <td>${performanceBadge}</td>
                        </tr>
                    `;
                });
            });
            
            tbody.innerHTML = html || '<tr><td colspan="10" style="text-align: center;">No data available</td></tr>';
        }
        
        function getPerformanceBadge(level) {
            const badges = {
                'excellent': '<span class="performance-badge performance-excellent">Excellent</span>',
                'good': '<span class="performance-badge performance-good">Good</span>',
                'average': '<span class="performance-badge performance-average">Average</span>',
                'low': '<span class="performance-badge performance-low">Below Target</span>'
            };
            return badges[level] || '';
        }
        
        function displayCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            // Sales Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const trendLabels = processedData.periods.map(p => `${p.start.substring(0, 5)}`);
            const salesData = processedData.periods.map(period => {
                let totalSales = 0;
                period.staff.forEach(data => totalSales += data.sales);
                return totalSales;
            });
            const goalsData = processedData.periods.map(period => {
                let totalGoals = 0;
                period.staff.forEach(data => totalGoals += data.adjustedGoal);
                return totalGoals;
            });
            
            charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Actual Sales',
                        data: salesData,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Adjusted Goals',
                        data: goalsData,
                        borderColor: 'rgb(248, 113, 113)',
                        backgroundColor: 'rgba(248, 113, 113, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Role Comparison Chart
            const roleCtx = document.getElementById('roleChart').getContext('2d');
            const roleData = { guides: [], managers: [] };
            
            processedData.periods.forEach(period => {
                let guidesSales = 0;
                let managersSales = 0;
                period.staff.forEach(data => {
                    if (data.role === 'guide') guidesSales += data.sales;
                    if (data.role === 'manager') managersSales += data.sales;
                });
                roleData.guides.push(guidesSales);
                roleData.managers.push(managersSales);
            });
            
            charts.role = new Chart(roleCtx, {
                type: 'bar',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Experience Guides',
                        data: roleData.guides,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)'
                    }, {
                        label: 'Managers',
                        data: roleData.managers,
                        backgroundColor: 'rgba(251, 191, 36, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });
            
            // Top Performers Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            const staffTotals = new Map();
            
            processedData.periods.forEach(period => {
                period.staff.forEach((data, staffName) => {
                    if (!staffTotals.has(staffName)) {
                        staffTotals.set(staffName, { sales: 0, role: data.role });
                    }
                    staffTotals.get(staffName).sales += data.sales;
                });
            });
            
            const topStaff = Array.from(staffTotals.entries())
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10);
            
            charts.performance = new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: topStaff.map(([name]) => name),
                    datasets: [{
                        label: 'Total Sales',
                        data: topStaff.map(([, data]) => data.sales),
                        backgroundColor: topStaff.map(([, data]) => 
                            data.role === 'manager' ? 'rgba(251, 191, 36, 0.8)' : 'rgba(59, 130, 246, 0.8)'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Achievement by Role Chart
            const achievementCtx = document.getElementById('achievementChart').getContext('2d');
            const roleAchievements = { guides: [], managers: [] };
            
            processedData.periods.forEach(period => {
                let guidesAch = [];
                let managersAch = [];
                period.staff.forEach(data => {
                    if (data.role === 'guide') guidesAch.push(parseFloat(data.achievementPercent));
                    if (data.role === 'manager') managersAch.push(parseFloat(data.achievementPercent));
                });
                roleAchievements.guides.push(guidesAch.length ? 
                    guidesAch.reduce((a,b) => a+b) / guidesAch.length : 0);
                roleAchievements.managers.push(managersAch.length ? 
                    managersAch.reduce((a,b) => a+b) / managersAch.length : 0);
            });
            
            charts.achievement = new Chart(achievementCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Experience Guides Avg %',
                        data: roleAchievements.guides,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Managers Avg %',
                        data: roleAchievements.managers,
                        borderColor: 'rgb(251, 191, 36)',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Achievement %'
                            }
                        }
                    }
                }
            });
        }
        
        function displayDetailedMetrics() {
            const staffMetrics = new Map();
            
            // Aggregate metrics by staff
            processedData.periods.forEach(period => {
                period.staff.forEach((data, staffName) => {
                    if (!staffMetrics.has(staffName)) {
                        staffMetrics.set(staffName, {
                            role: data.role,
                            totalHours: 0,
                            totalSales: 0,
                            totalLocalGuests: 0,
                            achievements: [],
                            periods: []
                        });
                    }
                    
                    const metrics = staffMetrics.get(staffName);
                    metrics.totalHours += data.hours;
                    metrics.totalSales += data.sales;
                    metrics.totalLocalGuests += data.localGuests;
                    metrics.achievements.push(parseFloat(data.achievementPercent));
                    metrics.periods.push({
                        period: `${period.start} - ${period.end}`,
                        achievement: parseFloat(data.achievementPercent)
                    });
                });
            });
            
            // Display in table
            const tbody = document.getElementById('metricsTableBody');
            let html = '';
            
            Array.from(staffMetrics.entries())
                .sort((a, b) => b[1].totalSales - a[1].totalSales)
                .forEach(([staffName, metrics]) => {
                    const salesPerHour = metrics.totalHours > 0 
                        ? (metrics.totalSales / metrics.totalHours).toFixed(2) 
                        : 0;
                    
                    const conversionRate = metrics.totalLocalGuests > 0 
                        ? ((metrics.totalSales / metrics.totalLocalGuests) * 100).toFixed(1) 
                        : 0;
                    
                    const avgAchievement = metrics.achievements.length > 0
                        ? (metrics.achievements.reduce((a, b) => a + b, 0) / metrics.achievements.length).toFixed(1)
                        : 0;
                    
                    const bestPeriod = metrics.periods.reduce((best, current) => 
                        current.achievement > best.achievement ? current : best,
                        { period: 'N/A', achievement: 0 }
                    );
                    
                    // Calculate trend
                    const trend = metrics.achievements.length > 1 
                        ? (metrics.achievements[metrics.achievements.length - 1] > metrics.achievements[0] ? '📈' : '📉')
                        : '➡️';
                    
                    const roleBadge = getRoleBadge(metrics.role);
                    
                    html += `
                        <tr>
                            <td><strong>${staffName}</strong></td>
                            <td>${roleBadge}</td>
                            <td>${metrics.totalHours.toFixed(1)}</td>
                            <td><strong>${metrics.totalSales}</strong></td>
                            <td>${salesPerHour}</td>
                            <td>${conversionRate}%</td>
                            <td><strong>${avgAchievement}%</strong></td>
                            <td>${bestPeriod.period}<br><small>(${bestPeriod.achievement.toFixed(1)}%)</small></td>
                            <td style="font-size: 1.5em;">${trend}</td>
                        </tr>
                    `;
                });
            
            tbody.innerHTML = html || '<tr><td colspan="9" style="text-align: center;">No data available</td></tr>';
        }
        
        function filterData() {
            const roleFilter = document.getElementById('roleFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            const staffFilter = document.getElementById('staffFilter').value;
            const performanceFilter = document.getElementById('performanceFilter').value;
            
            const rows = document.querySelectorAll('#performanceTableBody tr');
            
            rows.forEach(row => {
                let show = true;
                
                // Role filter
                if (roleFilter !== 'all' && row.getAttribute('data-role') !== roleFilter) {
                    show = false;
                }
                
                // Period filter
                if (periodFilter !== 'all') {
                    const period = processedData.periods[parseInt(periodFilter)];
                    const rowPeriod = row.getAttribute('data-period');
                    if (rowPeriod !== `${period.start}-${period.end}`) {
                        show = false;
                    }
                }
                
                // Staff filter
                if (staffFilter !== 'all' && row.getAttribute('data-staff') !== staffFilter) {
                    show = false;
                }
                
                // Performance filter
                if (performanceFilter !== 'all' && row.getAttribute('data-performance') !== performanceFilter) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        function exportToCSV() {
            if (!processedData) return;
            
            const data = [];
            
            processedData.periods.forEach(period => {
                period.staff.forEach((staffData, staffName) => {
                    data.push({
                        'Period Start': period.start,
                        'Period End': period.end,
                        'Staff Name': staffName,
                        'Role': staffData.role === 'guide' ? 'Experience Guide' : 
                               staffData.role === 'manager' ? 'Manager' : 'Unknown',
                        'Hours Worked': staffData.hours.toFixed(1),
                        'Local Guests': staffData.localGuests,
                        'OOT Guests': staffData.ootGuests,
                        'Actual Sales': staffData.sales,
                        'Adjusted Goal': staffData.adjustedGoal,
                        'Achievement %': staffData.achievementPercent,
                        'Sales per Hour': staffData.salesPerHour,
                        'Performance Level': staffData.performanceLevel
                    });
                });
            });
            
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'biweekly_sales_analysis.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
